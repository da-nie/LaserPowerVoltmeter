//----------------------------------------------------------------------------------------------------
//подключаемые библиотеки
//----------------------------------------------------------------------------------------------------

#include "mt16s2d.h"
#include "based.h"

//Всё отличие от WH1602 в адресе второй строки. У WH1602D она по адресу 40, а у MT16S2d по адресу 40h.

//----------------------------------------------------------------------------------------------------
//макроопределения
//----------------------------------------------------------------------------------------------------

//****************************************************************************************************
//настройки дисплея
//****************************************************************************************************
#define MT16S2D_RS_PORT    PORTD
#define MT16S2D_RS_DDR     DDRD
#define MT16S2D_RS         7

#define MT16S2D_E_PORT      PORTD
#define MT16S2D_E_DDR       DDRD
#define MT16S2D_E           5

#define MT16S2D_DB7_PORT  PORTB
#define MT16S2D_DB7_DDR   DDRB
#define MT16S2D_DB7       7

#define MT16S2D_DB6_PORT  PORTB
#define MT16S2D_DB6_DDR   DDRB
#define MT16S2D_DB6       6

#define MT16S2D_DB5_PORT  PORTB
#define MT16S2D_DB5_DDR   DDRB
#define MT16S2D_DB5       1

#define MT16S2D_DB4_PORT  PORTB
#define MT16S2D_DB4_DDR   DDRB
#define MT16S2D_DB4       0

//----------------------------------------------------------------------------------------------------
//константы
//----------------------------------------------------------------------------------------------------

//****************************************************************************************************
//массив перекодировки русских букв
//****************************************************************************************************
uint8_t RusCodeTable[66][2] PROGMEM=
{
 {'А','A'},
 {'Б',0b10100000},
 {'В','B'},
 {'Г',0b10100001},
 {'Д',0b11100000},
 {'Е','E'},
 {'Ё',0b10100010},
 {'Ж',0b10100011},
 {'З',0b10100100},
 {'И',0b10100101},
 {'Й',0b10100110},
 {'К','K'},
 {'Л',0b10100111},
 {'М','M'},
 {'Н','H'},
 {'О','O'},
 {'П',0b10101000},
 {'Р','P'},
 {'С','C'},
 {'Т','T'},
 {'У',0b10101001},
 {'Ф',0b10101010},
 {'Х','X'},
 {'Ц',0b11100001},
 {'Ч',0b10101011},
 {'Ш',0b10101100},
 {'Щ',0b11100010},
 {'Ъ',0b10101101},
 {'Ы',0b10101110},
 {'Ь','b'},
 {'Э',0b10101111},
 {'Ю',0b10110000},
 {'Я',0b10110001},
 
 {'а','a'},
 {'б',0b10110010},
 {'в',0b10110011},
 {'г',0b10110100},
 {'д',0b11100011},
 {'е','e'},
 {'ё',0b10110101},
 {'ж',0b10110110},
 {'з',0b10110111},
 {'и',0b10111000},
 {'й',0b10111001},
 {'к',0b10111010},
 {'л',0b10111011},
 {'м',0b10111100},
 {'н',0b10111101},
 {'о','o'},
 {'п',0b10111110},
 {'р','p'},
 {'с','c'},
 {'т',0b10111111},
 {'у','y'},
 {'ф',0b11100100},
 {'х','x'},
 {'ц',0b11100101},
 {'ч',0b11000000},
 {'ш',0b11000001},
 {'щ',0b11100110},
 {'ъ',0b11000010},
 {'ы',0b11000011},
 {'ь',0b11000100},
 {'э',0b11000101},
 {'ю',0b11000110},
 {'я',0b11000111}
};

//----------------------------------------------------------------------------------------------------
//прототипы функций
//----------------------------------------------------------------------------------------------------

void MT16S2D_SendNibble(uint8_t nibble);//послать ниббл
void MT16S2D_SendData(uint8_t byte);//послать данные
void MT16S2D_SendCommand(uint8_t byte);//послать команду

//----------------------------------------------------------------------------------------------------
//послать ниббл
//----------------------------------------------------------------------------------------------------
void MT16S2D_SendNibble(uint8_t nibble)
{ 
 MT16S2D_DB7_PORT&=0xff^(1<<MT16S2D_DB7);
 MT16S2D_DB6_PORT&=0xff^(1<<MT16S2D_DB6);
 MT16S2D_DB5_PORT&=0xff^(1<<MT16S2D_DB5);
 MT16S2D_DB4_PORT&=0xff^(1<<MT16S2D_DB4);
 MT16S2D_E_PORT|=(1<<MT16S2D_E); 
 MT16S2D_DB7_PORT|=(((nibble>>3)&0x01)<<MT16S2D_DB7);
 MT16S2D_DB6_PORT|=(((nibble>>2)&0x01)<<MT16S2D_DB6);
 MT16S2D_DB5_PORT|=(((nibble>>1)&0x01)<<MT16S2D_DB5);
 MT16S2D_DB4_PORT|=(((nibble>>0)&0x01)<<MT16S2D_DB4);
 _delay_us(100); 
 MT16S2D_E_PORT&=0xff^(1<<MT16S2D_E);
 _delay_us(100); 
}
//----------------------------------------------------------------------------------------------------
//послать данные
//----------------------------------------------------------------------------------------------------
void MT16S2D_SendData(uint8_t byte)
{
 MT16S2D_RS_PORT|=1<<MT16S2D_RS;//запись данных  
 MT16S2D_SendNibble(byte>>4);
 MT16S2D_SendNibble(byte&0x0f);
}
//----------------------------------------------------------------------------------------------------
//послать команду
//----------------------------------------------------------------------------------------------------
void MT16S2D_SendCommand(uint8_t byte)
{
 MT16S2D_RS_PORT&=0xff^(1<<MT16S2D_RS);//запись команд
 MT16S2D_SendNibble(byte>>4);
 MT16S2D_SendNibble(byte&0x0f);
}

//----------------------------------------------------------------------------------------------------
//инициализация дисплея
//----------------------------------------------------------------------------------------------------
void MT16S2D_Init(void)
{
 //настроим порты 
 MT16S2D_RS_DDR|=(1<<MT16S2D_RS);
 MT16S2D_E_DDR|=(1<<MT16S2D_E);
 MT16S2D_DB7_DDR|=(1<<MT16S2D_DB7);
 MT16S2D_DB6_DDR|=(1<<MT16S2D_DB6);
 MT16S2D_DB5_DDR|=(1<<MT16S2D_DB5);
 MT16S2D_DB4_DDR|=(1<<MT16S2D_DB4);
 _delay_ms(20);//ждём включения экрана
 //запускаем дисплей
 //даём несколько раз команду включения
 MT16S2D_RS_PORT&=0xff^(1<<MT16S2D_RS);//запись команд
 MT16S2D_SendNibble(0b0011);//команда включения
 _delay_ms(5); 
 MT16S2D_SendNibble(0b0011);//команда включения
 _delay_us(200);  
 MT16S2D_SendNibble(0b0011);//команда включения 
 MT16S2D_SendNibble(0b0010);//интерфейс 4 бит 
 //указываем режим 4 бита, 2 линии, символы 5x11
 MT16S2D_SendCommand(0b00101100);
 _delay_ms(1);
 //отключаем экран
 MT16S2D_SendCommand(0b00001000);
 _delay_ms(1); 
 //очищаем экран 
 MT16S2D_SendCommand(0b00000001);
 _delay_ms(1); 
 //устанавливаем режим ввода данных с инкрементом ячейки памяти
 MT16S2D_SendCommand(0b00000110);
 //включаем экран
 MT16S2D_SendCommand(0b00001100);
 _delay_ms(1);  
}
//----------------------------------------------------------------------------------------------------
//записать текст в верхнюю строчку экрана
//----------------------------------------------------------------------------------------------------
void MT16S2D_SetTextUpLine(char *text)
{
 //даём команду позиционирования
 MT16S2D_SendCommand(0b10000000);//установить адрес видеопамяти в 0
 _delay_us(100); 
 //преобразуем русские буквы
 uint8_t n;
 uint8_t out_text[16];
 for(n=0;n<16;n++)
 {
  uint8_t b=text[n];
  out_text[n]=b;
  for(uint8_t m=0;m<66;m++)
  {
   uint8_t t=pgm_read_byte(&(RusCodeTable[m][0]));
   if (t==b)
   {
    out_text[n]=pgm_read_byte(&(RusCodeTable[m][1]));
	break;
   }
  }
 } 
 for(n=0;n<16;n++)
 {
  if (text[n]==0) break;  
  MT16S2D_SendData(out_text[n]);
 }
 for(;n<16;n++) MT16S2D_SendData(32);//заполняем пробелами
}
//----------------------------------------------------------------------------------------------------
//записать текст в нижнюю строчку экрана
//----------------------------------------------------------------------------------------------------
void MT16S2D_SetTextDownLine(char *text)
{
 //даём команду позиционирования
 MT16S2D_SendCommand(0b11000000);//установить адрес видеопамяти в 40h
 _delay_us(100); 
 //преобразуем русские буквы
 uint8_t n;
 uint8_t out_text[16];
 for(n=0;n<16;n++)
 {
  uint8_t b=text[n];
  out_text[n]=b;
  for(uint8_t m=0;m<66;m++)
  {
   uint8_t t=pgm_read_byte(&(RusCodeTable[m][0]));
   if (t==b)
   {
    out_text[n]=pgm_read_byte(&(RusCodeTable[m][1]));
	break;
   }
  }
 } 
 for(n=0;n<16;n++)
 {
  if (text[n]==0) break;  
  MT16S2D_SendData(out_text[n]);
 }
 for(;n<16;n++) MT16S2D_SendData(32);//заполняем пробелами
}
//----------------------------------------------------------------------------------------------------
//записать текст из памяти в верхнюю строчку экрана
//----------------------------------------------------------------------------------------------------
void MT16S2D_SetTextProgmemUpLine(const char *text)
{
 //даём команду позиционирования
 MT16S2D_SendCommand(0b10000000);//установить адрес видеопамяти в 0
 _delay_us(100); 
 //преобразуем русские буквы
 uint8_t n;
 uint8_t out_text[16];
 for(n=0;n<16;n++)
 {
  uint8_t b=pgm_read_byte(&text[n]);
  out_text[n]=b;
  for(uint8_t m=0;m<66;m++)
  {
   uint8_t t=pgm_read_byte(&(RusCodeTable[m][0]));
   if (t==b)
   {
    out_text[n]=pgm_read_byte(&(RusCodeTable[m][1]));
	break;
   }
  }
 } 
 for(n=0;n<16;n++)
 {
  if (pgm_read_byte(&text[n])==0) break;  
  MT16S2D_SendData(out_text[n]);
 }
 for(;n<16;n++) MT16S2D_SendData(32);//заполняем пробелами
}
//----------------------------------------------------------------------------------------------------
//записать текст из памяти  в нижнюю строчку экрана
//----------------------------------------------------------------------------------------------------
void MT16S2D_SetTextProgmemDownLine(const char *text)
{
 //даём команду позиционирования
 MT16S2D_SendCommand(0b10101000);//установить адрес видеопамяти в 40
 _delay_us(100); 
 //преобразуем русские буквы
 uint8_t n;
 uint8_t out_text[16];
 for(n=0;n<16;n++)
 {
  uint8_t b=pgm_read_byte(&text[n]);
  out_text[n]=b;
  for(uint8_t m=0;m<66;m++)
  {
   uint8_t t=pgm_read_byte(&(RusCodeTable[m][0]));
   if (t==b)
   {
    out_text[n]=pgm_read_byte(&(RusCodeTable[m][1]));
	break;
   }
  }
 } 
 for(n=0;n<16;n++)
 {
  if (pgm_read_byte(&text[n])==0) break;  
  MT16S2D_SendData(out_text[n]);
 }
 for(;n<16;n++) MT16S2D_SendData(32);//заполняем пробелами
}


